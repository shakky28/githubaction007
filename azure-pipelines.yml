trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:
- stage: Terraform_Checks
  displayName: "Terraform fmt, validate & plan"
  jobs:
    - job: Plan
      steps:
        - task: TerraformInstaller@1
          displayName: Install Terraform
          inputs:
            terraformVersion: 'latest'

        - task: TerraformTaskV4@4
          displayName: "Terraform Init"
          inputs:
            provider: azurerm
            command: init
            workingDirectory: $(System.Default_Working_Directory)
            backendServiceArm: Shekhar-SVC
            backendAzureRmResourceGroupName: sgrg1000
            backendAzureRmStorageAccountName: stg50411
            backendAzureRmContainerName: tfstate
            backendAzureRmKey: task.terraform.tfstate

        - task: TerraformTaskV4@4
          displayName: "Terraform fmt"
          inputs:
            provider: azurerm
            command: custom
            workingDirectory: $(System.Default_Working_Directory)
            customCommand: fmt

        - task: TerraformTaskV4@4
          displayName: "Terraform validate"
          inputs:
            provider: azurerm
            command: validate
            workingDirectory: $(System.Default_Working_Directory)

        - task: TerraformTaskV4@4
          displayName: "Terraform plan"
          inputs:
            provider: azurerm
            command: plan
            workingDirectory: $(System.Default_Working_Directory)
            environmentServiceNameAzureRM: Shekhar-SVC
            commandOptions: "-out=tfplan"

- stage: Manual_Approval
  displayName: "Manual Validation"
  dependsOn: Terraform_Checks
  jobs:
    - job: Approval
      pool: server
      steps:
        - task: ManualValidation@0
          inputs:
            instructions: |
              Review Terraform plan output.
              Approve to proceed with APPLY.
            
- stage: Terraform_Apply
  displayName: "Terraform Apply"
  dependsOn: Manual_Approval
  condition: succeeded()
  jobs:
    - job: Apply
      steps:

        - task: TerraformTaskV4@4
          displayName: "Terraform Init"
          inputs:
            provider: azurerm
            command: init
            workingDirectory: $(System.Default_Working_Directory)
            backendServiceArm: Shekhar-SVC
            backendAzureRmResourceGroupName: sgrg1000
            backendAzureRmStorageAccountName: stg50411
            backendAzureRmContainerName: tfstate
            backendAzureRmKey: task.terraform.tfstate

        - download: current
          artifact: tfplan

        - task: TerraformTaskV4@4
          displayName: "Terraform Apply"
          inputs:
            provider: azurerm
            command: apply
            workingDirectory: $(System.Default_Working_Directory)
            environmentServiceNameAzureRM: Shekhar-SVC
            commandOptions: "tfplan"
